# Plan: Align Report Generator with Benchmark Restructure

## Goal

Update the report generation tools to match the restructured benchmark design from `refgetstore_benchmark_fix_plan.md`. The current report generator expects old data formats and produces a generic report that doesn't explain the two distinct benchmark scenarios (naming variants vs pangenome).

## Problem Diagnosis

### Mismatch Summary

**The Plan** (`refgetstore_benchmark_fix_plan.md`) proposes:
1. Two separate datasets: `naming_variants/` and `pangenome/`
2. New CSV columns: `genome_description`, `sequences_unique`
3. Clear narrative explaining WHY naming variants deduplicate and pangenome doesn't
4. Separate visualizations for each dataset

**The Report Generator** (embedded in `run_all_docker.sh` lines 193-301) currently:
1. Expects single "test" dataset with mixed files
2. Expects old CSV columns: `store_size`, `dedup_ratio` (not `refgetstore_size`, `refgetstore_dedup_ratio`)
3. Produces raw tables without explanatory narrative
4. No distinction between naming variants and pangenome scenarios

**The Static REPORT.md** in `results/`:
1. Is hand-crafted, not generated by the script
2. Contains outdated interpretation that doesn't match the plan
3. Will be overwritten by the generator, losing the custom content

### Specific Issues

1. **CSV Column Mismatch**:
   - Current CSV: `store_size`, `dedup_ratio`
   - Generator expects: same, but `deduplication.py` now outputs `refgetstore_size`, `refgetstore_dedup_ratio`
   - Plan proposes additional: `genome_description`, `sequences_unique`

2. **Report Structure**:
   - Current: Single section for "Deduplication Results"
   - Plan requires: Separate sections for naming variants (shows dedup works) and pangenome (shows dedup doesn't work)

3. **Narrative Missing**:
   - Current report is just tables
   - Plan requires explanation of WHY results are what they are

4. **Report Generator Location**:
   - Currently embedded as inline Python in `run_all_docker.sh` (hard to maintain)
   - Should be a proper Python module

## Files to Read for Context

- `/home/nsheff/Dropbox/workspaces/refgenie/repos/refgetstore-benchmark/run_all_docker.sh` - Contains embedded report generator (lines 193-301)
- `/home/nsheff/Dropbox/workspaces/refgenie/repos/refgetstore-benchmark/results/REPORT.md` - Current static report
- `/home/nsheff/Dropbox/workspaces/refgenie/repos/refgetstore-benchmark/results/deduplication.csv` - Current CSV format
- `/home/nsheff/Dropbox/workspaces/refgenie/repos/refgetstore-benchmark/benchmarks/deduplication.py` - Current deduplication benchmark
- `/home/nsheff/Dropbox/workspaces/refgenie/repos/refgetstore-benchmark/analysis/figures.py` - Visualization code
- `/home/nsheff/Dropbox/workspaces/refgenie/repos/refgetstore-benchmark/refgetstore_benchmarking_plan.md` - Master benchmarking plan
- `/home/nsheff/Dropbox/workspaces/refgenie/plans/refgetstore_benchmark_fix_plan.md` - The restructure plan

## Concrete Implementation Steps

### Step 1: Create Dedicated Report Generator Module

**Create `analysis/generate_report.py`**:

Extract the inline Python from `run_all_docker.sh` into a proper module with:

```python
def generate_report(results_dir: Path, plots_dir: Path, output_path: Path):
    """Generate benchmark report from CSV results."""
    ...
```

### Step 2: Update Report for Two-Dataset Structure

**Modify the report generator to handle:**

1. **Naming Variants Section**:
   - Load `results/naming_variants_deduplication.csv`
   - Show table of genomes added with naming convention labels
   - Highlight that all sequences are IDENTICAL
   - Show expected outcome: ~Nx savings (N = number of variants)
   - Include explanatory text: "RefgetStore deduplicates at the sequence level..."

2. **Pangenome Section** (Control):
   - Load `results/pangenome_deduplication.csv`
   - Show table with haplotype variants
   - Highlight that sequences DIFFER due to SNPs
   - Show expected outcome: ~1x savings (minimal dedup)
   - Include explanatory text: "Pangenome haplotypes have different sequences..."

3. **Comparison Summary**:
   - Side-by-side comparison of the two scenarios
   - Clear conclusion about when RefgetStore deduplication helps

### Step 3: Update CSV Column Handling

**Make report generator handle both old and new column formats:**

Old format (current):
```csv
dataset,n_genomes,genome_added,genome_gzip_size,cumulative_gzip_size,store_size,dedup_ratio
```

New format (after plan implementation):
```csv
dataset,n_genomes,genome_added,genome_description,genome_gzip_size,cumulative_gzip_size,refgetstore_size,refgetstore_dedup_ratio,sequences_unique
```

Use column name detection to handle both gracefully during transition.

### Step 4: Update run_all_docker.sh

**Replace inline Python with module call:**

Change lines 190-301 from embedded Python to:
```bash
echo "Generating benchmark report..."
$DOCKER_RUN bash -c "$INSTALL_GTARS && python -m analysis.generate_report"
```

### Step 5: Add Report Templates

**Create `analysis/report_templates.py`**:

Store the narrative text blocks as constants:
```python
NAMING_VARIANTS_INTRO = """
## Naming Variants Benchmark (The Key Demo)

This benchmark demonstrates RefgetStore's primary value proposition: **massive storage savings
when storing multiple "flavors" of the same genome** (different naming conventions, same sequences).

**Use case**: A lab has downloaded GRCh38 in multiple formats:
- UCSC (chr1, chr2, chrX)
- Ensembl (1, 2, X)
- NCBI (NC_000001.11, NC_000002.11)

All three have **identical underlying sequences** - only chromosome names differ.
"""

PANGENOME_INTRO = """
## Pangenome Benchmark (Control Case)

This benchmark shows when RefgetStore deduplication does **NOT** provide significant savings:
storing multiple haplotypes from a pangenome where sequences actually differ.

Each haplotype has ~0.1% SNP differences from the reference, meaning sequences are unique
and cannot be deduplicated.
"""
```

### Step 6: Update Visualization References

Ensure report references correct plot filenames:
- `plots/naming_variants_deduplication.png`
- `plots/pangenome_deduplication.png`
- Or combined: `plots/deduplication_comparison.png`

### Step 7: Delete Static REPORT.md

The hand-crafted `results/REPORT.md` should be deleted and regenerated by the new script. It will be auto-generated fresh each run.

## Alignment Checklist

After implementation, verify:

| Component | Plan Requirement | Report Generator |
|-----------|-----------------|------------------|
| Naming variants dataset | ✓ Separate dataset | ✓ Dedicated section |
| Pangenome dataset | ✓ Separate dataset | ✓ Dedicated section |
| Genome description | ✓ Column added | ✓ Shown in table |
| Sequences unique | ✓ Column added | ✓ Indicated in text |
| Why it works explanation | ✓ In plan | ✓ In report |
| Why it doesn't work explanation | ✓ In plan | ✓ In report |
| Separate visualizations | ✓ In plan | ✓ Referenced in report |

## Expected Report Structure

```markdown
# RefgetStore Benchmark Report

Generated: 2026-01-17

## Executive Summary
- Naming variants: Nx storage savings (deduplication works)
- Pangenome: ~1x savings (deduplication minimal)

## 1. Naming Variants Benchmark (The Key Demo)

[Narrative explanation...]

### Results

| # | Genome | Naming Convention | Cumulative Gzip | Store Size | Savings |
|---|--------|-------------------|-----------------|------------|---------|
| 1 | genome_ucsc | UCSC (chr1, chr2...) | X MB | Y MB | 1.0x |
| 2 | genome_ensembl | Ensembl (1, 2...) | 2X MB | Y MB | 2.0x |
| 3 | genome_ncbi | NCBI (NC_...) | 3X MB | Y MB | 3.0x |
...

![Naming Variants Deduplication](../plots/naming_variants_deduplication.png)

### Interpretation
All sequences are IDENTICAL. RefgetStore stores them once and achieves Nx savings.

## 2. Pangenome Benchmark (Control)

[Narrative explanation...]

### Results
...

### Interpretation
Sequences DIFFER due to SNPs. RefgetStore cannot deduplicate.

## 3. Storage Size Comparison
...

## 4. Random Access Performance
...

## 5. Conclusions
...
```

## Summary

**Before**: Report generator is embedded inline in bash script, expects old single-dataset format, produces tables without narrative.

**After**: Dedicated Python module that generates a narrative report aligned with the two-dataset benchmark structure, explaining both the success case (naming variants) and control case (pangenome).

## Important Notes

- **DO NOT MAINTAIN BACKWARDS COMPATIBILITY** - Delete the old embedded report generator entirely
- The static `REPORT.md` in results/ will be replaced by auto-generated version
- Report should be self-explanatory to someone who hasn't read the plan
